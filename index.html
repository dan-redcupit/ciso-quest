<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé§ The Ballad of the CISO: A Karaoke Quest üé∏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: 'Courier New', monospace;
            color: #e94560;
            overflow-x: hidden;
        }

        h1 {
            text-align: center;
            padding: 20px;
            text-shadow: 0 0 10px #e94560, 0 0 20px #e94560;
            font-size: 1.8em;
        }

        .game-container {
            display: flex;
            gap: 20px;
            padding: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        #gameCanvas {
            border: 4px solid #e94560;
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(233, 69, 96, 0.5);
            image-rendering: pixelated;
        }

        .side-panel {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #e94560;
            border-radius: 8px;
            padding: 15px;
            width: 280px;
            font-size: 12px;
        }

        .stats-panel h3, .inventory-panel h3, .quest-panel h3 {
            color: #00ff88;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .stat-bar {
            margin: 8px 0;
        }

        .stat-bar label {
            display: block;
            color: #fff;
            margin-bottom: 3px;
        }

        .bar-container {
            background: #333;
            border-radius: 4px;
            height: 16px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            transition: width 0.3s;
            border-radius: 4px;
        }

        .hp-bar { background: linear-gradient(90deg, #ff4444, #ff6666); }
        .xp-bar { background: linear-gradient(90deg, #44ff44, #66ff66); }
        .charisma-bar { background: linear-gradient(90deg, #ff44ff, #ff66ff); }
        .risk-bar { background: linear-gradient(90deg, #ffaa00, #ffcc44); }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .inventory-slot {
            background: #222;
            border: 1px solid #444;
            border-radius: 4px;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .inventory-slot.filled {
            border-color: #00ff88;
            background: #1a3a2a;
        }

        .quest-item {
            background: #1a1a2a;
            border-left: 3px solid #e94560;
            padding: 8px;
            margin: 5px 0;
            font-size: 11px;
        }

        .quest-item.completed {
            border-color: #00ff88;
            opacity: 0.6;
        }

        #dialogBox {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            border: 3px solid #00ff88;
            border-radius: 8px;
            padding: 20px;
            max-width: 600px;
            display: none;
            z-index: 100;
        }

        #dialogBox .speaker {
            color: #e94560;
            font-weight: bold;
            margin-bottom: 10px;
        }

        #dialogBox .message {
            color: #fff;
            line-height: 1.6;
        }

        #dialogBox .continue {
            color: #00ff88;
            font-size: 10px;
            margin-top: 10px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }

        .karaoke-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .karaoke-title {
            font-size: 2em;
            color: #e94560;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #e94560;
        }

        .lyrics-display {
            font-size: 1.5em;
            color: #fff;
            text-align: center;
            margin: 20px;
            min-height: 60px;
        }

        .note-highway {
            width: 400px;
            height: 100px;
            background: #111;
            border: 2px solid #e94560;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            margin: 20px;
        }

        .note-lane {
            position: absolute;
            bottom: 0;
            width: 25%;
            height: 100%;
            border-right: 1px solid #333;
        }

        .hit-zone {
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            height: 20px;
            background: rgba(233, 69, 96, 0.3);
            border-top: 2px solid #e94560;
        }

        .note {
            position: absolute;
            width: 40px;
            height: 20px;
            background: #00ff88;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #000;
        }

        .key-prompts {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .key-prompt {
            width: 60px;
            height: 60px;
            background: #333;
            border: 2px solid #666;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: #fff;
            transition: all 0.1s;
        }

        .key-prompt.active {
            background: #e94560;
            border-color: #fff;
            transform: scale(1.1);
        }

        .karaoke-score {
            font-size: 1.2em;
            color: #00ff88;
            margin-top: 20px;
        }

        .controls-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 4px;
            font-size: 10px;
            color: #888;
        }

        .title-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 300;
        }

        .title-screen h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .title-screen .subtitle {
            color: #00ff88;
            margin-bottom: 30px;
            font-style: italic;
        }

        .start-btn {
            background: #e94560;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s;
            margin: 10px;
        }

        .start-btn:hover {
            background: #ff6b8a;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(233, 69, 96, 0.5);
        }

        .title-art {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .minimap {
            width: 100%;
            height: 80px;
            background: #111;
            border: 1px solid #444;
            border-radius: 4px;
            margin-top: 10px;
            position: relative;
        }

        .minimap-player {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #e94560;
            border-radius: 50%;
        }

        .level-indicator {
            text-align: center;
            padding: 10px;
            background: linear-gradient(90deg, #e94560, #ff6b8a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.5em;
            font-weight: bold;
        }

        .certification-badge {
            display: inline-block;
            background: #1a3a2a;
            border: 1px solid #00ff88;
            border-radius: 4px;
            padding: 2px 6px;
            margin: 2px;
            font-size: 9px;
            color: #00ff88;
        }

        .tips-box {
            background: #1a1a3a;
            border: 1px solid #4444ff;
            border-radius: 4px;
            padding: 8px;
            margin-top: 10px;
            font-size: 10px;
            color: #8888ff;
        }

        .tips-box strong {
            color: #aaaaff;
        }

        /* CEO MODE STYLES */
        .ceo-mode {
            border-color: gold !important;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8) !important;
        }

        .ceo-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #000;
            padding: 20px 40px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 500;
            animation: popupBounce 0.5s ease-out;
        }

        @keyframes popupBounce {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        /* D20 ROLL ANIMATION */
        .d20-roll {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4em;
            z-index: 400;
            animation: diceRoll 1s ease-out forwards;
            text-shadow: 0 0 20px #fff;
        }

        @keyframes diceRoll {
            0% { transform: translate(-50%, -50%) rotate(0deg) scale(0); opacity: 1; }
            50% { transform: translate(-50%, -50%) rotate(360deg) scale(1.5); }
            100% { transform: translate(-50%, -50%) rotate(720deg) scale(0); opacity: 0; }
        }

        .crit-text {
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2em;
            color: #ffd700;
            text-shadow: 0 0 10px #ffd700, 0 0 20px #ff0000;
            z-index: 401;
            animation: critFade 1.5s ease-out forwards;
        }

        @keyframes critFade {
            0% { opacity: 0; transform: translateX(-50%) scale(0.5); }
            20% { opacity: 1; transform: translateX(-50%) scale(1.2); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-50px); }
        }

        /* RUBBER DUCK */
        .rubber-duck {
            position: fixed;
            bottom: 100px;
            left: 20px;
            font-size: 3em;
            cursor: pointer;
            transition: transform 0.2s;
            z-index: 50;
            display: none;
        }

        .rubber-duck:hover {
            transform: scale(1.2) rotate(-10deg);
        }

        .duck-speech {
            position: fixed;
            bottom: 160px;
            left: 20px;
            background: #fff;
            color: #000;
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 200px;
            font-size: 11px;
            z-index: 51;
            display: none;
        }

        .duck-speech::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 20px;
            border: 5px solid transparent;
            border-top-color: #fff;
        }

        /* COFFEE POWERUP */
        .coffee-counter {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            padding: 8px 12px;
            border-radius: 5px;
            color: #fff;
            font-size: 12px;
            z-index: 50;
            display: none;
        }

        .caffeine-shake {
            animation: caffeineShake 0.1s infinite;
        }

        @keyframes caffeineShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px) rotate(-0.5deg); }
            75% { transform: translateX(2px) rotate(0.5deg); }
        }

        /* SECRET COMMAND TOAST */
        .secret-toast {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #ff0000;
            color: #ff0000;
            padding: 20px 30px;
            border-radius: 8px;
            z-index: 600;
            font-family: 'Courier New', monospace;
            animation: toastSlide 3s ease-out forwards;
        }

        @keyframes toastSlide {
            0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* MEETING MINIGAME */
        .meeting-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(50, 50, 80, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 250;
        }

        .sleepy-meter {
            width: 300px;
            height: 30px;
            background: #333;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px;
        }

        .sleepy-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #ffff00, #ff0000);
            transition: width 0.3s;
        }

        .meeting-clicker {
            font-size: 4em;
            cursor: pointer;
            animation: bobHead 2s infinite;
        }

        @keyframes bobHead {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-15deg); }
            75% { transform: rotate(15deg); }
        }
    </style>
</head>
<body>
    <!-- Title Screen -->
    <div class="title-screen" id="titleScreen">
        <div class="title-art">üé§üè∞üé∏</div>
        <h1>The Ballad of the CISO</h1>
        <p class="subtitle">A Karaoke Quest Through Corporate Dungeons</p>
        <p style="color: #888; max-width: 500px; text-align: center; margin: 20px; line-height: 1.6;">
            You are a humble GRC Manager, armed with nothing but your compliance frameworks
            and a dream of becoming the legendary CISO. Navigate the treacherous Corporate Dungeon,
            defeat security threats with the power of SONG, and collect the sacred Musical Instruments
            of Governance!
        </p>
        <button class="start-btn" onclick="startGame()">üéµ Begin Your Quest üéµ</button>
        <p style="color: #666; margin-top: 30px; font-size: 10px;">
            WASD/Arrows to move | SPACE to interact | JKLM for Karaoke battles
        </p>
    </div>

    <h1>üé§ The Ballad of the CISO üé∏</h1>

    <div class="game-container">
        <div class="side-panel stats-panel">
            <div class="level-indicator">
                <span id="playerTitle">GRC Analyst</span>
            </div>
            <h3>üìä D20 Stats</h3>

            <div class="stat-bar">
                <label>‚ù§Ô∏è Sanity (HP): <span id="hpValue">100</span>/100</label>
                <div class="bar-container">
                    <div class="bar-fill hp-bar" id="hpBar" style="width: 100%"></div>
                </div>
            </div>

            <div class="stat-bar">
                <label>‚≠ê Experience: <span id="xpValue">0</span>/<span id="xpMax">100</span></label>
                <div class="bar-container">
                    <div class="bar-fill xp-bar" id="xpBar" style="width: 0%"></div>
                </div>
            </div>

            <div class="stat-bar">
                <label>üíú Charisma (Executive Buy-in): <span id="charismaValue">10</span></label>
                <div class="bar-container">
                    <div class="bar-fill charisma-bar" id="charismaBar" style="width: 50%"></div>
                </div>
            </div>

            <div class="stat-bar">
                <label>üé≤ Risk Appetite: <span id="riskValue">50</span>%</label>
                <div class="bar-container">
                    <div class="bar-fill risk-bar" id="riskBar" style="width: 50%"></div>
                </div>
            </div>

            <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #444;">
                <p style="color: #888; font-size: 10px;">üéØ Battles Won: <span id="battlesWon">0</span></p>
                <p style="color: #888; font-size: 10px;">üìú Policies Sung: <span id="policiesSung">0</span></p>
                <p style="color: #888; font-size: 10px;">üèÜ Current Zone: <span id="currentZone">Lobby</span></p>
            </div>

            <div id="certifications" style="margin-top: 10px;">
                <p style="color: #00ff88; font-size: 10px;">üèÖ Certifications:</p>
                <span class="certification-badge">Security+</span>
            </div>
        </div>

        <canvas id="gameCanvas" width="640" height="480"></canvas>

        <div class="side-panel">
            <div class="inventory-panel">
                <h3>üé∏ Sacred Instruments</h3>
                <div class="inventory-grid" id="inventoryGrid">
                    <div class="inventory-slot" title="Empty"></div>
                    <div class="inventory-slot" title="Empty"></div>
                    <div class="inventory-slot" title="Empty"></div>
                    <div class="inventory-slot" title="Empty"></div>
                    <div class="inventory-slot" title="Empty"></div>
                    <div class="inventory-slot" title="Empty"></div>
                    <div class="inventory-slot" title="Empty"></div>
                    <div class="inventory-slot" title="Empty"></div>
                </div>
            </div>

            <div class="quest-panel" style="margin-top: 15px;">
                <h3>üìú Active Quests</h3>
                <div id="questList">
                    <div class="quest-item">
                        üéØ Complete Security Awareness Training (talk to HR)
                    </div>
                    <div class="quest-item">
                        üîê Defeat the Phishing Dragon in IT Dungeon
                    </div>
                    <div class="quest-item">
                        üìã Collect 3 Compliance Scrolls
                    </div>
                </div>
            </div>

            <div class="tips-box">
                <strong>üí° CISO Tip:</strong>
                <p id="cisoTip">Remember: The 'S' in IoT stands for 'Security'.</p>
            </div>

            <div class="minimap">
                <div class="minimap-player" id="minimapPlayer"></div>
            </div>
        </div>
    </div>

    <div id="dialogBox">
        <div class="speaker" id="dialogSpeaker">???</div>
        <div class="message" id="dialogMessage">...</div>
        <div class="continue">Press SPACE to continue...</div>
    </div>

    <div class="karaoke-overlay" id="karaokeOverlay">
        <div class="karaoke-title">üé§ KARAOKE BATTLE! üé§</div>
        <div id="enemyName" style="color: #ff4444; font-size: 1.2em;">VS. PHISHING EMAIL</div>
        <div class="lyrics-display" id="lyricsDisplay">Get ready to sing your security policy!</div>
        <div class="note-highway" id="noteHighway">
            <div class="note-lane" style="left: 0%;"></div>
            <div class="note-lane" style="left: 25%;"></div>
            <div class="note-lane" style="left: 50%;"></div>
            <div class="note-lane" style="left: 75%;"></div>
            <div class="hit-zone"></div>
        </div>
        <div class="key-prompts">
            <div class="key-prompt" id="keyJ">J</div>
            <div class="key-prompt" id="keyK">K</div>
            <div class="key-prompt" id="keyL">L</div>
            <div class="key-prompt" id="keyM">M</div>
        </div>
        <div class="karaoke-score">
            Score: <span id="karaokeScore">0</span> | Combo: <span id="karaokeCombo">0</span>x
        </div>
        <div style="margin-top: 20px; color: #888;">Enemy HP: <span id="enemyHp">100</span></div>
    </div>

    <div class="controls-info">
        WASD/Arrows: Move | SPACE: Interact | JKLM: Karaoke | Q: Consult Duck
    </div>

    <!-- RUBBER DUCK DEBUGGER -->
    <div class="rubber-duck" id="rubberDuck" onclick="consultDuck()">ü¶Ü</div>
    <div class="duck-speech" id="duckSpeech"></div>

    <!-- COFFEE COUNTER -->
    <div class="coffee-counter" id="coffeeCounter">‚òï Caffeine: <span id="caffeineLevel">0</span>%</div>

    <!-- MEETING SURVIVAL MINIGAME -->
    <div class="meeting-overlay" id="meetingOverlay">
        <h2 style="color: #e94560;">üö® SURPRISE STANDUP! üö®</h2>
        <p style="color: #fff; margin: 10px;">Click to stay awake! Don't let sleepiness reach 100%!</p>
        <div class="sleepy-meter">
            <div class="sleepy-fill" id="sleepyFill" style="width: 0%"></div>
        </div>
        <div class="meeting-clicker" id="meetingClicker" onclick="clickToStayAwake()">üò¥</div>
        <p style="color: #888; font-size: 12px;" id="meetingBuzz">"Let's circle back on that..."</p>
    </div>

    <script>
        // ==================== GAME STATE ====================
        const game = {
            player: {
                x: 320,
                y: 400,
                speed: 4,
                hp: 100,
                maxHp: 100,
                xp: 0,
                xpToLevel: 100,
                level: 1,
                charisma: 10,
                riskAppetite: 50,
                battlesWon: 0,
                policiesSung: 0,
                title: "GRC Analyst",
                instruments: [],
                certifications: ["Security+"],
                quests: [
                    { id: 1, text: "Complete Security Awareness Training", completed: false },
                    { id: 2, text: "Defeat the Phishing Dragon", completed: false },
                    { id: 3, text: "Collect 3 Compliance Scrolls", completed: false, progress: 0 }
                ]
            },
            currentZone: 'lobby',
            keys: {},
            dialogActive: false,
            dialogQueue: [],
            karaokeActive: false,
            entities: [],
            collectibles: [],
            zones: {},
            // ZANY FEATURES STATE
            ceoMode: false,
            konamiProgress: 0,
            secretBuffer: '',
            hasDuck: false,
            duckConsults: 0,
            caffeine: 0,
            meetingActive: false,
            sleepiness: 0
        };

        // KONAMI CODE: ‚Üë‚Üë‚Üì‚Üì‚Üê‚Üí‚Üê‚ÜíBA
        const KONAMI_CODE = ['arrowup','arrowup','arrowdown','arrowdown','arrowleft','arrowright','arrowleft','arrowright','b','a'];

        // SECRET COMMANDS
        const SECRET_COMMANDS = {
            'sudo': "Nice try. But you don't have root in THIS dungeon. üîí",
            'rm -rf': "THE SYSADMIN HAS BLOCKED THIS ACTION. No deleting the prod database today! üõ°Ô∏è",
            'password': "üö® ALERT: Credential Stuffing Gremlin detected your weakness!",
            'compliance': "Did someone say COMPLIANCE?! *hands you a 200-page PDF* üìö",
            'exit': "There is no escape from corporate. Only promotions. üìà",
            'help': "It's dangerous to go alone! Take this... VPN. üõ°Ô∏è",
            'ping': "Pong! ...wait, is the firewall blocking ICMP again? üèì",
            'coffee': "‚òï +10 Caffeine! Your hands are shaking but your code reviews are FAST.",
            'hack': "We prefer the term 'Authorized Penetration Testing' here. üé©",
            'git push -f': "WHOA THERE! Force pushing to main? That's a paddlin'. üèè"
        };

        // RUBBER DUCK WISDOM
        const DUCK_WISDOM = [
            "Quack! Have you tried turning it off and on again?",
            "Quack quack! The vulnerability is probably in the code you didn't write tests for.",
            "QUACK! Did you check the logs? Nobody ever checks the logs.",
            "Quack... Have you considered that the user IS the threat model?",
            "Quack quack quack! Security is everyone's responsibility. Especially yours. Right now.",
            "Quack! The password policy says 12 characters minimum. '12characters' is not what they meant.",
            "QUACK QUACK! Is it in the NIST framework? If not, does it even exist?",
            "Quack... The real zero-day was the friends we made along the way.",
            "Quack! Compliance is a floor, not a ceiling. But most people trip on the floor anyway.",
            "QUACK! *judges your security posture silently*",
            "Quack quack! The S in IoT really does stand for Security. It's just... invisible.",
            "Quack... You seem stressed. Have you tried implementing Zero Trust?",
            "QUAAAACK! Why is the SOC analyst crying? Oh right, it's Tuesday."
        ];

        // MEETING BUZZWORDS
        const MEETING_BUZZWORDS = [
            "Let's circle back on that...",
            "Can we take this offline?",
            "What's the ROI on that?",
            "Let's synergize our security posture...",
            "Per my last email...",
            "Moving forward...",
            "Let's unpack that...",
            "I'm going to push back on that...",
            "Let's put a pin in it...",
            "We need to be more proactive...",
            "This is a journey, not a destination...",
            "We need to move the needle on this...",
            "Let's socialize this with stakeholders..."
        ];

        // CEO MODE INTERRUPTIONS
        const CEO_INTERRUPTIONS = [
            "Can we circle back on that? üîÑ",
            "What's the ROI? üìä",
            "My nephew could do this cheaper... üë¶",
            "Is this AI-powered? ü§ñ",
            "Can we blockchain this? ‚õìÔ∏è",
            "The board is asking questions... üò∞",
            "I read an article about this on LinkedIn... üì±",
            "Can you make it more... synergistic? ‚ú®"
        ];

        // ==================== ZONES & MAPS ====================
        const TILE_SIZE = 32;
        const MAP_WIDTH = 20;
        const MAP_HEIGHT = 15;

        // Zone definitions with snarky descriptions
        const zones = {
            lobby: {
                name: "Corporate Lobby",
                description: "Where dreams come to fill out compliance forms",
                color: "#2a2a4a",
                walls: [
                    // Border walls
                    ...Array(20).fill().map((_, i) => ({x: i, y: 0})),
                    ...Array(20).fill().map((_, i) => ({x: i, y: 14})),
                    ...Array(15).fill().map((_, i) => ({x: 0, y: i})),
                    ...Array(15).fill().map((_, i) => ({x: 19, y: i})),
                    // Reception desk
                    {x: 8, y: 3}, {x: 9, y: 3}, {x: 10, y: 3}, {x: 11, y: 3},
                    // Planters
                    {x: 3, y: 3}, {x: 16, y: 3},
                    {x: 3, y: 10}, {x: 16, y: 10},
                ],
                npcs: [
                    {
                        x: 9 * TILE_SIZE + 16,
                        y: 4 * TILE_SIZE + 16,
                        sprite: 'üë©‚Äçüíº',
                        name: "Janet from HR",
                        dialog: [
                            "Welcome to CyberCorp‚Ñ¢, where our security is 'military-grade'!",
                            "That means we use the same passwords as the military... in 1995.",
                            "I need you to complete the Security Awareness Training.",
                            "It's a 47-slide PowerPoint about not clicking suspicious links.",
                            "Ironic, since the training link looks EXACTLY like a phishing email.",
                            "üí° TIP: As a future CISO, you'll learn that training completion rates matter more than actual learning. Welcome to corporate!"
                        ],
                        questId: 1
                    },
                    {
                        x: 5 * TILE_SIZE + 16,
                        y: 7 * TILE_SIZE + 16,
                        sprite: 'üßô‚Äç‚ôÇÔ∏è',
                        name: "The Compliance Wizard",
                        dialog: [
                            "Ah, a fellow traveler on the path to CISO-hood!",
                            "I once was like you... young, naive, thinking 'compliance' meant 'security'.",
                            "*laughs in audit findings*",
                            "Take this scroll. It contains the sacred wisdom of SOC 2.",
                            "Remember: Being compliant doesn't mean you're secure...",
                            "...but being secure doesn't matter if you're not compliant! üìú",
                            "üí° TIP: Frameworks like SOC 2, ISO 27001, and NIST CSF are your friends. Learn to speak their language!"
                        ],
                        givesItem: { type: 'scroll', name: 'SOC 2 Scroll', emoji: 'üìú' }
                    }
                ],
                exits: [
                    { x: 19, y: 7, to: 'it_dungeon', spawnX: 1 * TILE_SIZE + 16, spawnY: 7 * TILE_SIZE + 16 },
                    { x: 9, y: 0, to: 'executive_floor', spawnX: 9 * TILE_SIZE + 16, spawnY: 13 * TILE_SIZE + 16 }
                ],
                enemies: []
            },
            it_dungeon: {
                name: "IT Dungeon",
                description: "Where tickets go to die",
                color: "#1a2a1a",
                walls: [
                    ...Array(20).fill().map((_, i) => ({x: i, y: 0})),
                    ...Array(20).fill().map((_, i) => ({x: i, y: 14})),
                    ...Array(15).fill().map((_, i) => ({x: 0, y: i})),
                    ...Array(15).fill().map((_, i) => ({x: 19, y: i})),
                    // Server racks
                    {x: 5, y: 3}, {x: 6, y: 3}, {x: 7, y: 3},
                    {x: 12, y: 3}, {x: 13, y: 3}, {x: 14, y: 3},
                    {x: 5, y: 6}, {x: 6, y: 6}, {x: 7, y: 6},
                    {x: 12, y: 6}, {x: 13, y: 6}, {x: 14, y: 6},
                    // Cable management nightmare
                    {x: 9, y: 9}, {x: 10, y: 9}, {x: 11, y: 9},
                ],
                npcs: [
                    {
                        x: 3 * TILE_SIZE + 16,
                        y: 8 * TILE_SIZE + 16,
                        sprite: 'üßë‚Äçüíª',
                        name: "Dave the Sysadmin",
                        dialog: [
                            "Oh great, another security person here to tell me my passwords aren't 'secure enough'.",
                            "Listen, 'Server123!' has worked for 15 years and I'm not changing it now.",
                            "You want MFA? The CEO said it's 'too inconvenient'.",
                            "But sure, I'LL be the one blamed when we get breached.",
                            "The Phishing Dragon? It's in the server room. Good luck.",
                            "üí° TIP: Building relationships with IT is crucial. They control the infrastructure you're trying to protect!"
                        ]
                    },
                    {
                        x: 16 * TILE_SIZE + 16,
                        y: 11 * TILE_SIZE + 16,
                        sprite: 'üé∏',
                        name: "The Legendary Firewall Guitar",
                        dialog: [
                            "You found the FIREWALL GUITAR!",
                            "Legend says it was forged in the flames of a thousand blocked ports.",
                            "With it, you can shred through network threats!",
                            "üé∏ +10 to Threat Detection | +5 to Looking Cool in Meetings"
                        ],
                        givesItem: { type: 'instrument', name: 'Firewall Guitar', emoji: 'üé∏', bonus: 'threat_detection' }
                    }
                ],
                exits: [
                    { x: 0, y: 7, to: 'lobby', spawnX: 18 * TILE_SIZE + 16, spawnY: 7 * TILE_SIZE + 16 },
                    { x: 19, y: 7, to: 'vendor_valley', spawnX: 1 * TILE_SIZE + 16, spawnY: 7 * TILE_SIZE + 16 },
                    // SECRET EXIT TO SHADOW IT - behind the server rack!
                    { x: 9, y: 10, to: 'shadow_it', spawnX: 18 * TILE_SIZE, spawnY: 7 * TILE_SIZE + 16, secret: true }
                ],
                enemies: [
                    {
                        x: 10 * TILE_SIZE + 16,
                        y: 4 * TILE_SIZE + 16,
                        sprite: 'üêâ',
                        name: "The Phishing Dragon",
                        hp: 100,
                        lyrics: [
                            "‚ô™ Click this link, it's totally fine! ‚ô™",
                            "‚ô™ Your CEO needs gift cards, that's not a sign! ‚ô™",
                            "‚ô™ Nigerian princes deserve your trust! ‚ô™",
                            "‚ô™ Wire that money or your computer's dust! ‚ô™"
                        ],
                        defeatDialog: [
                            "NOOOO! My engagement metrics!",
                            "You've defeated me with your Security Awareness!",
                            "But I shall return... in a slightly different email template!",
                            "üí° TIP: Phishing remains the #1 attack vector. As CISO, invest in user training AND technical controls!"
                        ],
                        questId: 2,
                        xpReward: 50
                    }
                ]
            },
            vendor_valley: {
                name: "Vendor Valley",
                description: "Where budgets go to die",
                color: "#2a1a2a",
                walls: [
                    ...Array(20).fill().map((_, i) => ({x: i, y: 0})),
                    ...Array(20).fill().map((_, i) => ({x: i, y: 14})),
                    ...Array(15).fill().map((_, i) => ({x: 0, y: i})),
                    ...Array(15).fill().map((_, i) => ({x: 19, y: i})),
                    // Vendor booths
                    {x: 4, y: 3}, {x: 5, y: 3}, {x: 4, y: 4}, {x: 5, y: 4},
                    {x: 9, y: 3}, {x: 10, y: 3}, {x: 9, y: 4}, {x: 10, y: 4},
                    {x: 14, y: 3}, {x: 15, y: 3}, {x: 14, y: 4}, {x: 15, y: 4},
                    {x: 4, y: 9}, {x: 5, y: 9}, {x: 4, y: 10}, {x: 5, y: 10},
                    {x: 14, y: 9}, {x: 15, y: 9}, {x: 14, y: 10}, {x: 15, y: 10},
                ],
                npcs: [
                    {
                        x: 4 * TILE_SIZE + 48,
                        y: 5 * TILE_SIZE + 16,
                        sprite: 'ü¶π',
                        name: "AI Security Vendor",
                        dialog: [
                            "Our AI-powered blockchain quantum solution stops 157% of threats!",
                            "How? Don't worry about it. Here's a whitepaper full of buzzwords.",
                            "We're basically magic, but enterprise-grade magic.",
                            "That'll be $500K per year. Per endpoint. Per user. Per thought.",
                            "üí° TIP: Always do POCs and check references. Vendors will promise the moon but deliver a flashlight."
                        ]
                    },
                    {
                        x: 9 * TILE_SIZE + 48,
                        y: 5 * TILE_SIZE + 16,
                        sprite: 'üé≠',
                        name: "Compliance Tool Sales Guy",
                        dialog: [
                            "TIRED of actually reading compliance frameworks?",
                            "Our tool automatically checks boxes for you!",
                            "Auditors HATE this one weird trick!",
                            "Side effects may include: false confidence, audit failures, and regret.",
                            "üí° TIP: Tools help, but understanding the 'why' behind controls is what separates good CISOs from checkbox jockeys."
                        ]
                    },
                    {
                        x: 14 * TILE_SIZE + 48,
                        y: 5 * TILE_SIZE + 16,
                        sprite: 'ü•Å',
                        name: "The Risk Assessment Drums",
                        dialog: [
                            "You found the RISK ASSESSMENT DRUMS!",
                            "Beat them to quantify threats and impress the board!",
                            "Each drum represents: LIKELIHOOD, IMPACT, and MITIGATION.",
                            "ü•Å +10 to Risk Communication | +5 to Board Presentations"
                        ],
                        givesItem: { type: 'instrument', name: 'Risk Drums', emoji: 'ü•Å', bonus: 'risk_assessment' }
                    },
                    {
                        x: 4 * TILE_SIZE + 48,
                        y: 11 * TILE_SIZE + 16,
                        sprite: 'üìú',
                        name: "Free Compliance Scroll",
                        dialog: [
                            "A wild HIPAA scroll appears!",
                            "It's covered in medical jargon and acronyms.",
                            "But it's yours now! üìú"
                        ],
                        givesItem: { type: 'scroll', name: 'HIPAA Scroll', emoji: 'üìú' }
                    }
                ],
                exits: [
                    { x: 0, y: 7, to: 'it_dungeon', spawnX: 18 * TILE_SIZE + 16, spawnY: 7 * TILE_SIZE + 16 },
                    { x: 9, y: 14, to: 'audit_arena', spawnX: 9 * TILE_SIZE + 16, spawnY: 1 * TILE_SIZE + 16 }
                ],
                enemies: [
                    {
                        x: 10 * TILE_SIZE + 16,
                        y: 10 * TILE_SIZE + 16,
                        sprite: 'üëî',
                        name: "Aggressive Sales Rep",
                        hp: 80,
                        lyrics: [
                            "‚ô™ Sign the contract, just trust me bro! ‚ô™",
                            "‚ô™ Three year lock-in, let's go go go! ‚ô™",
                            "‚ô™ Features? Roadmap! Coming soon! ‚ô™",
                            "‚ô™ Your budget's mine, you sweet sweet goon! ‚ô™"
                        ],
                        defeatDialog: [
                            "Fine! Take your free trial and GO!",
                            "But you'll be BACK! They always come back!",
                            "üí° TIP: Never sign multi-year contracts without out-clauses. Vendor relationships change!"
                        ],
                        xpReward: 40
                    }
                ]
            },
            executive_floor: {
                name: "Executive Floor",
                description: "Where security budgets are decided by people who reuse passwords",
                color: "#3a2a1a",
                walls: [
                    ...Array(20).fill().map((_, i) => ({x: i, y: 0})),
                    ...Array(20).fill().map((_, i) => ({x: i, y: 14})),
                    ...Array(15).fill().map((_, i) => ({x: 0, y: i})),
                    ...Array(15).fill().map((_, i) => ({x: 19, y: i})),
                    // Executive offices
                    {x: 2, y: 2}, {x: 3, y: 2}, {x: 4, y: 2}, {x: 2, y: 3}, {x: 4, y: 3},
                    {x: 15, y: 2}, {x: 16, y: 2}, {x: 17, y: 2}, {x: 15, y: 3}, {x: 17, y: 3},
                    // Conference table
                    {x: 8, y: 6}, {x: 9, y: 6}, {x: 10, y: 6}, {x: 11, y: 6},
                    {x: 8, y: 7}, {x: 9, y: 7}, {x: 10, y: 7}, {x: 11, y: 7},
                ],
                npcs: [
                    {
                        x: 3 * TILE_SIZE + 16,
                        y: 4 * TILE_SIZE + 16,
                        sprite: 'üë®‚Äçüíº',
                        name: "The CFO",
                        dialog: [
                            "Security budget? In THIS economy?",
                            "Can't you just... use free antivirus?",
                            "My nephew says he can do penetration testing for exposure.",
                            "What do you MEAN 'that's not how it works'?",
                            "üí° TIP: Learn to speak in business terms. ROI, risk reduction, and regulatory fines resonate more than technical jargon."
                        ]
                    },
                    {
                        x: 16 * TILE_SIZE + 16,
                        y: 4 * TILE_SIZE + 16,
                        sprite: 'üë©‚Äçüíº',
                        name: "The CEO",
                        dialog: [
                            "Ah yes, cyber... very important. I read about it on LinkedIn.",
                            "Can you make our security more... AI? The board loves AI.",
                            "Also, I need you to whitelist my personal iPad. It's fine.",
                            "And my home network. And my vacation home. For... business.",
                            "Why are you making that face?",
                            "üí° TIP: Executive exceptions are inevitable. Document them, get sign-off, and include them in risk assessments!"
                        ]
                    },
                    {
                        x: 9 * TILE_SIZE + 48,
                        y: 10 * TILE_SIZE + 16,
                        sprite: 'üéπ',
                        name: "The Governance Keyboard",
                        dialog: [
                            "You found the GOVERNANCE KEYBOARD!",
                            "Each key represents a different policy domain!",
                            "Play a chord of Access Control, Data Protection, and Incident Response!",
                            "üéπ +10 to Policy Development | +5 to Audit Readiness"
                        ],
                        givesItem: { type: 'instrument', name: 'Governance Keyboard', emoji: 'üéπ', bonus: 'governance' }
                    }
                ],
                exits: [
                    { x: 9, y: 14, to: 'lobby', spawnX: 9 * TILE_SIZE + 16, spawnY: 1 * TILE_SIZE + 16 }
                ],
                enemies: [
                    {
                        x: 10 * TILE_SIZE,
                        y: 5 * TILE_SIZE,
                        sprite: 'üìä',
                        name: "Death by PowerPoint",
                        hp: 120,
                        lyrics: [
                            "‚ô™ Synergy! Alignment! Circle back! ‚ô™",
                            "‚ô™ This could've been an email, but I lack! ‚ô™",
                            "‚ô™ Fifty slides of meaningless graphs! ‚ô™",
                            "‚ô™ Your soul will break in two halves! ‚ô™"
                        ],
                        defeatDialog: [
                            "But... my deck was so comprehensive!",
                            "Fine! Take this certification of meeting survival!",
                            "üèÖ You earned: 'Meeting Survivor' badge!",
                            "üí° TIP: Learn to give crisp, executive-friendly briefings. The board doesn't want technical deep-dives!"
                        ],
                        xpReward: 60,
                        givesCert: "Meeting Survivor"
                    }
                ]
            },
            audit_arena: {
                name: "Audit Arena",
                description: "Where documentation goes to be judged",
                color: "#1a1a3a",
                walls: [
                    ...Array(20).fill().map((_, i) => ({x: i, y: 0})),
                    ...Array(20).fill().map((_, i) => ({x: i, y: 14})),
                    ...Array(15).fill().map((_, i) => ({x: 0, y: i})),
                    ...Array(15).fill().map((_, i) => ({x: 19, y: i})),
                    // Arena seating
                    {x: 2, y: 2}, {x: 3, y: 2}, {x: 4, y: 2}, {x: 5, y: 2},
                    {x: 14, y: 2}, {x: 15, y: 2}, {x: 16, y: 2}, {x: 17, y: 2},
                    {x: 2, y: 3}, {x: 17, y: 3},
                    {x: 2, y: 4}, {x: 17, y: 4},
                    // Evidence table
                    {x: 8, y: 10}, {x: 9, y: 10}, {x: 10, y: 10}, {x: 11, y: 10},
                ],
                npcs: [
                    {
                        x: 5 * TILE_SIZE + 16,
                        y: 8 * TILE_SIZE + 16,
                        sprite: 'üìã',
                        name: "NIST Framework Scroll",
                        dialog: [
                            "A NIST CSF scroll! The holy grail of frameworks!",
                            "Contains the five sacred functions: Identify, Protect, Detect, Respond, Recover.",
                            "Also 108 subcategories because nothing in security is simple.",
                            "üìú You got the NIST Scroll!"
                        ],
                        givesItem: { type: 'scroll', name: 'NIST Scroll', emoji: 'üìú' }
                    },
                    {
                        x: 3 * TILE_SIZE + 16,
                        y: 5 * TILE_SIZE + 16,
                        sprite: 'üîç',
                        name: "Friendly Internal Auditor",
                        dialog: [
                            "Hey! I'm here to HELP, not to get you fired!",
                            "...is what I say before I get people fired.",
                            "Just kidding! But seriously, where are your change management logs?",
                            "You DO have change management logs, right?",
                            "*concerned auditor noises*",
                            "üí° TIP: Auditors are your friends! Regular internal audits catch issues before external auditors do."
                        ]
                    },
                    {
                        x: 14 * TILE_SIZE + 16,
                        y: 11 * TILE_SIZE + 16,
                        sprite: 'üé∫',
                        name: "The Incident Response Horn",
                        dialog: [
                            "You found the INCIDENT RESPONSE HORN!",
                            "Sound it when breaches occur! It can be heard across all departments!",
                            "Warning: May cause panic, finger-pointing, and emergency meetings.",
                            "üé∫ +10 to Incident Management | +5 to Crisis Communication"
                        ],
                        givesItem: { type: 'instrument', name: 'IR Horn', emoji: 'üé∫', bonus: 'incident_response' }
                    }
                ],
                exits: [
                    { x: 9, y: 0, to: 'vendor_valley', spawnX: 9 * TILE_SIZE + 16, spawnY: 13 * TILE_SIZE + 16 },
                    { x: 19, y: 7, to: 'ciso_throne', spawnX: 1 * TILE_SIZE + 16, spawnY: 7 * TILE_SIZE + 16 }
                ],
                enemies: [
                    {
                        x: 10 * TILE_SIZE,
                        y: 6 * TILE_SIZE,
                        sprite: 'üìë',
                        name: "The External Auditor",
                        hp: 150,
                        lyrics: [
                            "‚ô™ Show me evidence, show me proof! ‚ô™",
                            "‚ô™ Your controls are loose, your docs aloof! ‚ô™",
                            "‚ô™ I'll write findings until you cry! ‚ô™",
                            "‚ô™ Your compliance score's about to die! ‚ô™"
                        ],
                        defeatDialog: [
                            "Impressive! Your documentation is... actually adequate?!",
                            "This is unprecedented! Take this Clean Audit badge!",
                            "üèÖ You earned: 'Clean Audit' certification!",
                            "üí° TIP: Continuous compliance beats audit cramming. If you're always audit-ready, audits are just check-ins!"
                        ],
                        xpReward: 80,
                        givesCert: "Clean Audit"
                    }
                ]
            },
            ciso_throne: {
                name: "The CISO Throne Room",
                description: "Your destiny awaits... if you're worthy",
                color: "#3a1a3a",
                walls: [
                    ...Array(20).fill().map((_, i) => ({x: i, y: 0})),
                    ...Array(20).fill().map((_, i) => ({x: i, y: 14})),
                    ...Array(15).fill().map((_, i) => ({x: 0, y: i})),
                    ...Array(15).fill().map((_, i) => ({x: 19, y: i})),
                    // Throne room pillars
                    {x: 4, y: 3}, {x: 15, y: 3},
                    {x: 4, y: 6}, {x: 15, y: 6},
                    {x: 4, y: 9}, {x: 15, y: 9},
                    // Throne platform
                    {x: 8, y: 2}, {x: 9, y: 2}, {x: 10, y: 2}, {x: 11, y: 2},
                ],
                npcs: [
                    {
                        x: 9 * TILE_SIZE + 48,
                        y: 3 * TILE_SIZE + 16,
                        sprite: 'üëë',
                        name: "The Empty CISO Throne",
                        dialog: [
                            "The throne sits empty, awaiting a worthy leader...",
                            "One who has mastered Governance, Risk, and Compliance.",
                            "One who can communicate with both executives and engineers.",
                            "One who knows that security is a journey, not a destination.",
                            "One who has collected the Sacred Instruments and earned their certifications.",
                            "Could that leader be... YOU?",
                            "üí° Final TIP: A great CISO balances technical knowledge with business acumen, and never stops learning. The throne awaits!"
                        ],
                        checkWin: true
                    },
                    {
                        x: 6 * TILE_SIZE + 16,
                        y: 11 * TILE_SIZE + 16,
                        sprite: 'üéª',
                        name: "The Violin of Vendor Management",
                        dialog: [
                            "You found the VENDOR MANAGEMENT VIOLIN!",
                            "Play sorrowful tunes when contracts auto-renew!",
                            "Play joyful tunes when you negotiate a discount!",
                            "üéª +10 to Third Party Risk | +5 to Contract Negotiation"
                        ],
                        givesItem: { type: 'instrument', name: 'Vendor Violin', emoji: 'üéª', bonus: 'vendor_management' }
                    },
                    {
                        x: 13 * TILE_SIZE + 16,
                        y: 11 * TILE_SIZE + 16,
                        sprite: 'ü™ó',
                        name: "The Accordion of Access Control",
                        dialog: [
                            "You found the ACCESS CONTROL ACCORDION!",
                            "Expand and contract permissions like its bellows!",
                            "Principle of least privilege has never been so musical!",
                            "ü™ó +10 to IAM | +5 to Zero Trust Architecture"
                        ],
                        givesItem: { type: 'instrument', name: 'Access Accordion', emoji: 'ü™ó', bonus: 'access_control' }
                    }
                ],
                exits: [
                    { x: 0, y: 7, to: 'audit_arena', spawnX: 18 * TILE_SIZE + 16, spawnY: 7 * TILE_SIZE + 16 }
                ],
                enemies: [
                    {
                        x: 10 * TILE_SIZE,
                        y: 7 * TILE_SIZE,
                        sprite: 'ü¶†',
                        name: "The Ransomware Boss",
                        hp: 200,
                        lyrics: [
                            "‚ô™ All your files belong to me! ‚ô™",
                            "‚ô™ Pay in Bitcoin, set them free! ‚ô™",
                            "‚ô™ No backups? What a shame! ‚ô™",
                            "‚ô™ You've only got yourself to blame! ‚ô™"
                        ],
                        defeatDialog: [
                            "IMPOSSIBLE! You had... TESTED BACKUPS?!",
                            "And INCIDENT RESPONSE PLANS?! Who DOES that?!",
                            "You've proven yourself worthy of the CISO throne!",
                            "üèÖ You earned: 'Ransomware Slayer' certification!",
                            "üí° WISDOM: Backups are not backups until they're tested. IR plans are not plans until they're practiced!"
                        ],
                        xpReward: 150,
                        givesCert: "Ransomware Slayer",
                        isBoss: true
                    }
                ]
            },
            // SECRET ZONE - THE SHADOW IT CLOUD
            shadow_it: {
                name: "The Shadow IT Cloud ‚òÅÔ∏è",
                description: "Unsanctioned. Undocumented. Unstoppable.",
                color: "#0a0a2a",
                walls: [
                    ...Array(20).fill().map((_, i) => ({x: i, y: 0})),
                    ...Array(20).fill().map((_, i) => ({x: i, y: 14})),
                    ...Array(15).fill().map((_, i) => ({x: 0, y: i})),
                    ...Array(15).fill().map((_, i) => ({x: 19, y: i})),
                    // Floating cloud platforms
                    {x: 5, y: 4}, {x: 6, y: 4}, {x: 13, y: 4}, {x: 14, y: 4},
                    {x: 9, y: 7}, {x: 10, y: 7},
                    {x: 3, y: 10}, {x: 16, y: 10},
                ],
                npcs: [
                    {
                        x: 5 * TILE_SIZE + 48,
                        y: 5 * TILE_SIZE + 16,
                        sprite: 'üßë‚Äçüíª',
                        name: "Neo the Rogue Developer",
                        dialog: [
                            "Welcome to The Cloud‚Ñ¢... the REAL cloud.",
                            "Not the one IT approved. The one that actually WORKS.",
                            "You want AWS credentials? I've got 47 root accounts.",
                            "The compliance team? They can't reach us here.",
                            "*offers you a red pill* See how deep the technical debt goes?",
                            "There is no patch... for human stupidity.",
                            "üí° SECRET TIP: Shadow IT exists because official IT is too slow. Fix the process, not just the symptoms!"
                        ]
                    },
                    {
                        x: 14 * TILE_SIZE + 16,
                        y: 5 * TILE_SIZE + 16,
                        sprite: 'ü¶Ü',
                        name: "The Legendary Debug Duck",
                        dialog: [
                            "QUACK QUACK QUACK!",
                            "You found me! The legendary Rubber Duck Debugger!",
                            "I shall join your quest and offer questionable advice!",
                            "Press Q anytime to consult my infinite wisdom!",
                            "ü¶Ü DUCK ACQUIRED! Check your screen corners!"
                        ],
                        givesDuck: true
                    },
                    {
                        x: 9 * TILE_SIZE + 48,
                        y: 11 * TILE_SIZE + 16,
                        sprite: 'üé∑',
                        name: "The Saxophone of Shadow IT",
                        dialog: [
                            "You found the SHADOW IT SAXOPHONE!",
                            "Play smooth jazz while deploying to production on Friday!",
                            "Its music calms angry sysadmins and auditors alike.",
                            "üé∑ +10 to Stealth Deployments | +5 to Plausible Deniability"
                        ],
                        givesItem: { type: 'instrument', name: 'Shadow Sax', emoji: 'üé∑', bonus: 'shadow_it' }
                    }
                ],
                exits: [
                    { x: 0, y: 7, to: 'it_dungeon', spawnX: 10 * TILE_SIZE, spawnY: 10 * TILE_SIZE + 16 }
                ],
                enemies: [
                    {
                        x: 10 * TILE_SIZE,
                        y: 4 * TILE_SIZE,
                        sprite: 'üìã',
                        name: "The Rogue Jira Board",
                        hp: 100,
                        lyrics: [
                            "‚ô™ Sprint 47, still not done! ‚ô™",
                            "‚ô™ Story points are just for fun! ‚ô™",
                            "‚ô™ Blocked by dependencies galore! ‚ô™",
                            "‚ô™ Technical debt forevermore! ‚ô™"
                        ],
                        defeatDialog: [
                            "My... my velocity! It's... actually being measured now!",
                            "Fine! Take the rubber duck and GO!",
                            "üèÖ You earned: 'Agile Survivor' certification!",
                            "üí° TIP: Shadow IT often signals process failures. Listen to what it's telling you!"
                        ],
                        xpReward: 75,
                        givesCert: "Agile Survivor"
                    }
                ]
            }
        };

        // ==================== CANVAS & RENDERING ====================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // ==================== SECURITY KARAOKE LYRICS ====================
        const securityLyrics = [
            "‚ô™ Don't click links in emails you don't trust! ‚ô™",
            "‚ô™ Strong passwords are an absolute must! ‚ô™",
            "‚ô™ MFA saves the day, every single time! ‚ô™",
            "‚ô™ Weak security should be a crime! ‚ô™",
            "‚ô™ Patch your systems, don't delay! ‚ô™",
            "‚ô™ Zero-day exploits are here to stay! ‚ô™",
            "‚ô™ Encrypt your data, at rest and in flight! ‚ô™",
            "‚ô™ Security posture must be tight! ‚ô™",
            "‚ô™ Principle of least privilege, that's the way! ‚ô™",
            "‚ô™ Defense in depth will save the day! ‚ô™",
            "‚ô™ Social engineering is the real threat! ‚ô™",
            "‚ô™ Training your users, don't forget! ‚ô™",
            "‚ô™ Incident response, have a plan! ‚ô™",
            "‚ô™ Test those backups when you can! ‚ô™",
            "‚ô™ Risk assessment, prioritize! ‚ô™",
            "‚ô™ Business impact, strategize! ‚ô™"
        ];

        const cisoTips = [
            "The 'S' in IoT stands for 'Security'.",
            "Compliance ‚â† Security, but try explaining that to the board.",
            "Every vendor is 'AI-powered' now. Question everything.",
            "Your threat model should include 'employees clicking things'.",
            "The best incident response is the one you never need. The second best is the one you've practiced.",
            "Security culture beats security tools. But you still need both.",
            "If you can't measure it, you can't manage it. If you can't explain it, you won't get budget for it.",
            "Zero Trust doesn't mean trust no one. It means verify everyone.",
            "The CISO role is 10% security, 90% politics and communication.",
            "Your security is only as strong as your weakest password... which is probably 'Winter2024!'",
            "GRC is not a four-letter word. Well, it is, but not THAT kind.",
            "The board doesn't want to hear about CVEs. They want to hear about risk to revenue.",
            "Shadow IT exists because we made legitimate IT too hard to use."
        ];

        // ==================== GAME INITIALIZATION ====================
        function loadZone(zoneName) {
            game.currentZone = zoneName;
            const zone = zones[zoneName];
            game.entities = [];
            game.collectibles = [];

            // Load NPCs
            zone.npcs.forEach(npc => {
                if (!npc.collected) {
                    game.entities.push({...npc, type: 'npc'});
                }
            });

            // Load enemies
            zone.enemies.forEach(enemy => {
                if (!enemy.defeated) {
                    game.entities.push({...enemy, type: 'enemy'});
                }
            });

            document.getElementById('currentZone').textContent = zone.name;
            updateTip();
        }

        function startGame() {
            document.getElementById('titleScreen').style.display = 'none';
            loadZone('lobby');
            gameLoop();
        }

        // ==================== INPUT HANDLING ====================
        document.addEventListener('keydown', (e) => {
            game.keys[e.key.toLowerCase()] = true;

            if (game.karaokeActive) {
                handleKaraokeInput(e.key.toLowerCase());
            } else if (game.dialogActive && (e.key === ' ' || e.key === 'Enter')) {
                advanceDialog();
            } else if (e.key === ' ' && !game.dialogActive) {
                checkInteraction();
            }
        });

        document.addEventListener('keyup', (e) => {
            game.keys[e.key.toLowerCase()] = false;
        });

        // ==================== MOVEMENT & COLLISION ====================
        function isWall(x, y) {
            const zone = zones[game.currentZone];
            const tileX = Math.floor(x / TILE_SIZE);
            const tileY = Math.floor(y / TILE_SIZE);
            return zone.walls.some(w => w.x === tileX && w.y === tileY);
        }

        function checkCollision(newX, newY) {
            const padding = 12;
            return isWall(newX - padding, newY - padding) ||
                   isWall(newX + padding, newY - padding) ||
                   isWall(newX - padding, newY + padding) ||
                   isWall(newX + padding, newY + padding);
        }

        function checkExit(x, y) {
            const zone = zones[game.currentZone];
            const tileX = Math.floor(x / TILE_SIZE);
            const tileY = Math.floor(y / TILE_SIZE);

            for (const exit of zone.exits) {
                if (exit.x === tileX && exit.y === tileY) {
                    game.player.x = exit.spawnX;
                    game.player.y = exit.spawnY;
                    loadZone(exit.to);
                    return;
                }
            }
        }

        function updatePlayer() {
            if (game.dialogActive || game.karaokeActive) return;

            let dx = 0, dy = 0;

            if (game.keys['w'] || game.keys['arrowup']) dy -= game.player.speed;
            if (game.keys['s'] || game.keys['arrowdown']) dy += game.player.speed;
            if (game.keys['a'] || game.keys['arrowleft']) dx -= game.player.speed;
            if (game.keys['d'] || game.keys['arrowright']) dx += game.player.speed;

            // Normalize diagonal movement
            if (dx !== 0 && dy !== 0) {
                dx *= 0.707;
                dy *= 0.707;
            }

            const newX = game.player.x + dx;
            const newY = game.player.y + dy;

            if (!checkCollision(newX, game.player.y)) {
                game.player.x = newX;
            }
            if (!checkCollision(game.player.x, newY)) {
                game.player.y = newY;
            }

            // Clamp to bounds
            game.player.x = Math.max(16, Math.min(canvas.width - 16, game.player.x));
            game.player.y = Math.max(16, Math.min(canvas.height - 16, game.player.y));

            checkExit(game.player.x, game.player.y);

            // Update minimap
            const minimapPlayer = document.getElementById('minimapPlayer');
            minimapPlayer.style.left = (game.player.x / canvas.width * 100) + '%';
            minimapPlayer.style.top = (game.player.y / canvas.height * 100) + '%';
        }

        // ==================== INTERACTION ====================
        function checkInteraction() {
            const interactionRange = 50;

            for (const entity of game.entities) {
                const dx = entity.x - game.player.x;
                const dy = entity.y - game.player.y;
                const dist = Math.sqrt(dx * dx + dy * dy);

                if (dist < interactionRange) {
                    if (entity.type === 'npc') {
                        startDialog(entity);
                    } else if (entity.type === 'enemy') {
                        startKaraokeBattle(entity);
                    }
                    return;
                }
            }
        }

        // ==================== DIALOG SYSTEM ====================
        function startDialog(npc) {
            game.dialogActive = true;
            game.currentNpc = npc;
            game.dialogIndex = 0;
            game.dialogQueue = [...npc.dialog];

            showDialog(npc.name, game.dialogQueue[0]);
        }

        function showDialog(speaker, message) {
            const dialogBox = document.getElementById('dialogBox');
            document.getElementById('dialogSpeaker').textContent = speaker;
            document.getElementById('dialogMessage').textContent = message;
            dialogBox.style.display = 'block';
        }

        function advanceDialog() {
            game.dialogIndex++;

            if (game.dialogIndex < game.dialogQueue.length) {
                showDialog(game.currentNpc.name, game.dialogQueue[game.dialogIndex]);
            } else {
                endDialog();
            }
        }

        function endDialog() {
            document.getElementById('dialogBox').style.display = 'none';
            game.dialogActive = false;

            const npc = game.currentNpc;

            // Handle quest completion
            if (npc.questId) {
                const quest = game.player.quests.find(q => q.id === npc.questId);
                if (quest && !quest.completed) {
                    quest.completed = true;
                    addXp(25);
                    updateQuestUI();
                }
            }

            // Handle item giving
            if (npc.givesItem && !npc.collected) {
                addItem(npc.givesItem);
                npc.collected = true;

                // Remove from entities
                const idx = game.entities.findIndex(e => e === npc);
                if (idx > -1) game.entities.splice(idx, 1);

                // Mark as collected in zone
                const zoneNpc = zones[game.currentZone].npcs.find(n => n.name === npc.name);
                if (zoneNpc) zoneNpc.collected = true;
            }

            // Check win condition
            if (npc.checkWin) {
                checkWinCondition();
            }

            game.currentNpc = null;
        }

        function addItem(item) {
            game.player.instruments.push(item);
            updateInventoryUI();

            // Check scroll collection quest
            if (item.type === 'scroll') {
                const quest = game.player.quests.find(q => q.id === 3);
                if (quest) {
                    quest.progress = (quest.progress || 0) + 1;
                    if (quest.progress >= 3) {
                        quest.completed = true;
                        addXp(50);
                    }
                    updateQuestUI();
                }
            }
        }

        // ==================== KARAOKE BATTLE SYSTEM ====================
        let karaokeState = {
            enemy: null,
            score: 0,
            combo: 0,
            notes: [],
            enemyHp: 100,
            lyricIndex: 0
        };

        function startKaraokeBattle(enemy) {
            game.karaokeActive = true;
            karaokeState = {
                enemy: enemy,
                score: 0,
                combo: 0,
                notes: [],
                enemyHp: enemy.hp,
                lyricIndex: 0
            };

            document.getElementById('karaokeOverlay').style.display = 'flex';
            document.getElementById('enemyName').textContent = `VS. ${enemy.name.toUpperCase()}`;
            document.getElementById('lyricsDisplay').textContent = enemy.lyrics[0];
            document.getElementById('enemyHp').textContent = karaokeState.enemyHp;
            document.getElementById('karaokeScore').textContent = '0';
            document.getElementById('karaokeCombo').textContent = '0';

            spawnKaraokeNotes();
        }

        function spawnKaraokeNotes() {
            const keys = ['j', 'k', 'l', 'm'];
            const highway = document.getElementById('noteHighway');

            // Clear existing notes
            highway.querySelectorAll('.note').forEach(n => n.remove());
            karaokeState.notes = [];

            // Spawn new wave of notes
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    if (!game.karaokeActive) return;

                    const lane = Math.floor(Math.random() * 4);
                    const note = document.createElement('div');
                    note.className = 'note';
                    note.textContent = keys[lane].toUpperCase();
                    note.style.left = (lane * 25 + 12.5 - 5) + '%';
                    note.style.top = '-20px';
                    note.dataset.lane = lane;
                    note.dataset.key = keys[lane];

                    highway.appendChild(note);
                    karaokeState.notes.push(note);

                    animateNote(note);
                }, i * 500);
            }
        }

        function animateNote(note) {
            let pos = -20;
            const interval = setInterval(() => {
                if (!game.karaokeActive) {
                    clearInterval(interval);
                    return;
                }

                pos += 3;
                note.style.top = pos + 'px';

                if (pos > 100) {
                    clearInterval(interval);
                    note.remove();
                    karaokeState.combo = 0;
                    document.getElementById('karaokeCombo').textContent = '0';

                    // Miss - reduce score slightly
                    karaokeState.score = Math.max(0, karaokeState.score - 5);
                    document.getElementById('karaokeScore').textContent = karaokeState.score;
                }
            }, 30);

            note.dataset.interval = interval;
        }

        function handleKaraokeInput(key) {
            const keyMap = {j: 0, k: 1, l: 2, m: 3};
            const lane = keyMap[key];

            if (lane === undefined) return;

            // Visual feedback
            const keyPrompt = document.getElementById('key' + key.toUpperCase());
            keyPrompt.classList.add('active');
            setTimeout(() => keyPrompt.classList.remove('active'), 100);

            // Check for hit
            const hitZone = {min: 60, max: 90};
            let hit = false;

            for (const note of karaokeState.notes) {
                const pos = parseInt(note.style.top);
                const noteLane = parseInt(note.dataset.lane);

                if (noteLane === lane && pos >= hitZone.min && pos <= hitZone.max) {
                    // Hit!
                    hit = true;
                    karaokeState.combo++;
                    karaokeState.score += 10 * (1 + Math.floor(karaokeState.combo / 5));
                    karaokeState.enemyHp -= 5 + karaokeState.combo;

                    note.style.background = '#ff4444';
                    clearInterval(note.dataset.interval);
                    setTimeout(() => note.remove(), 100);

                    karaokeState.notes = karaokeState.notes.filter(n => n !== note);

                    document.getElementById('karaokeScore').textContent = karaokeState.score;
                    document.getElementById('karaokeCombo').textContent = karaokeState.combo;
                    document.getElementById('enemyHp').textContent = Math.max(0, karaokeState.enemyHp);

                    // Update lyrics
                    karaokeState.lyricIndex = (karaokeState.lyricIndex + 1) % karaokeState.enemy.lyrics.length;
                    document.getElementById('lyricsDisplay').textContent =
                        securityLyrics[Math.floor(Math.random() * securityLyrics.length)];

                    break;
                }
            }

            if (!hit) {
                karaokeState.combo = 0;
                document.getElementById('karaokeCombo').textContent = '0';
            }

            // Check win/continue
            if (karaokeState.enemyHp <= 0) {
                endKaraokeBattle(true);
            } else if (karaokeState.notes.length === 0 && karaokeState.enemyHp > 0) {
                // Spawn more notes
                setTimeout(spawnKaraokeNotes, 500);
            }
        }

        function endKaraokeBattle(won) {
            game.karaokeActive = false;
            document.getElementById('karaokeOverlay').style.display = 'none';

            if (won) {
                const enemy = karaokeState.enemy;
                game.player.battlesWon++;
                game.player.policiesSung++;

                // Show defeat dialog
                game.dialogActive = true;
                game.currentNpc = { name: enemy.name, dialog: enemy.defeatDialog };
                game.dialogIndex = 0;
                game.dialogQueue = [...enemy.defeatDialog];
                showDialog(enemy.name, game.dialogQueue[0]);

                // Grant rewards
                addXp(enemy.xpReward);

                if (enemy.givesCert) {
                    game.player.certifications.push(enemy.givesCert);
                    updateCertificationsUI();
                }

                // Mark enemy as defeated
                const idx = game.entities.findIndex(e => e === enemy);
                if (idx > -1) game.entities.splice(idx, 1);

                const zoneEnemy = zones[game.currentZone].enemies.find(e => e.name === enemy.name);
                if (zoneEnemy) zoneEnemy.defeated = true;

                // Quest completion
                if (enemy.questId) {
                    const quest = game.player.quests.find(q => q.id === enemy.questId);
                    if (quest) quest.completed = true;
                    updateQuestUI();
                }

                updateStatsUI();
            }
        }

        // ==================== XP & LEVELING ====================
        const titles = [
            { level: 1, title: "GRC Analyst", xp: 100 },
            { level: 2, title: "Security Analyst", xp: 200 },
            { level: 3, title: "GRC Manager", xp: 350 },
            { level: 4, title: "Security Manager", xp: 500 },
            { level: 5, title: "Director of Security", xp: 700 },
            { level: 6, title: "VP of Security", xp: 900 },
            { level: 7, title: "CISO", xp: 1200 }
        ];

        function addXp(amount) {
            game.player.xp += amount;

            // Check for level up
            const nextTitle = titles.find(t => t.level === game.player.level + 1);
            if (nextTitle && game.player.xp >= game.player.xpToLevel) {
                game.player.level++;
                game.player.xpToLevel = nextTitle.xp;
                game.player.title = nextTitle.title;
                game.player.charisma += 5;
                game.player.maxHp += 10;
                game.player.hp = game.player.maxHp;

                document.getElementById('playerTitle').textContent = game.player.title;
            }

            updateStatsUI();
        }

        // ==================== WIN CONDITION ====================
        function checkWinCondition() {
            const hasAllInstruments = game.player.instruments.filter(i => i.type === 'instrument').length >= 5;
            const hasCerts = game.player.certifications.length >= 4;
            const level = game.player.level;

            if (hasAllInstruments && hasCerts && level >= 5) {
                // WIN!
                setTimeout(() => {
                    alert(`üéâ CONGRATULATIONS! üéâ\n\nYou have become the CISO!\n\nYour journey through the Corporate Dungeon has taught you:\n\n` +
                        `‚úÖ Governance, Risk, and Compliance aren't just buzzwords\n` +
                        `‚úÖ Communication is more important than technical skills\n` +
                        `‚úÖ Security is a business enabler, not a blocker\n` +
                        `‚úÖ People are both your greatest vulnerability and your greatest asset\n` +
                        `‚úÖ The real CISO was the friends (and policies) we made along the way\n\n` +
                        `Final Score: ${game.player.xp} XP | Battles Won: ${game.player.battlesWon}\n\n` +
                        `Now go forth and secure the realm! üè∞üîê`);
                }, 500);
            } else {
                let missing = [];
                if (!hasAllInstruments) missing.push("Collect all 5 Sacred Instruments");
                if (!hasCerts) missing.push("Earn more certifications (defeat enemies)");
                if (level < 5) missing.push("Reach at least Director level");

                setTimeout(() => {
                    alert(`You're not quite ready for the throne yet!\n\nYou still need to:\n- ${missing.join('\n- ')}\n\nKeep exploring and growing!`);
                }, 500);
            }
        }

        // ==================== UI UPDATES ====================
        function updateStatsUI() {
            document.getElementById('hpValue').textContent = game.player.hp;
            document.getElementById('hpBar').style.width = (game.player.hp / game.player.maxHp * 100) + '%';

            document.getElementById('xpValue').textContent = game.player.xp;
            document.getElementById('xpMax').textContent = game.player.xpToLevel;
            document.getElementById('xpBar').style.width = (game.player.xp / game.player.xpToLevel * 100) + '%';

            document.getElementById('charismaValue').textContent = game.player.charisma;
            document.getElementById('charismaBar').style.width = (game.player.charisma / 20 * 100) + '%';

            document.getElementById('battlesWon').textContent = game.player.battlesWon;
            document.getElementById('policiesSung').textContent = game.player.policiesSung;
        }

        function updateInventoryUI() {
            const grid = document.getElementById('inventoryGrid');
            const slots = grid.querySelectorAll('.inventory-slot');

            slots.forEach((slot, i) => {
                if (game.player.instruments[i]) {
                    slot.textContent = game.player.instruments[i].emoji;
                    slot.classList.add('filled');
                    slot.title = game.player.instruments[i].name;
                } else {
                    slot.textContent = '';
                    slot.classList.remove('filled');
                    slot.title = 'Empty';
                }
            });
        }

        function updateQuestUI() {
            const questList = document.getElementById('questList');
            questList.innerHTML = '';

            game.player.quests.forEach(quest => {
                const div = document.createElement('div');
                div.className = 'quest-item' + (quest.completed ? ' completed' : '');
                let text = (quest.completed ? '‚úÖ ' : 'üéØ ') + quest.text;
                if (quest.progress !== undefined && !quest.completed) {
                    text += ` (${quest.progress}/3)`;
                }
                div.textContent = text;
                questList.appendChild(div);
            });
        }

        function updateCertificationsUI() {
            const container = document.getElementById('certifications');
            container.innerHTML = '<p style="color: #00ff88; font-size: 10px;">üèÖ Certifications:</p>';

            game.player.certifications.forEach(cert => {
                const badge = document.createElement('span');
                badge.className = 'certification-badge';
                badge.textContent = cert;
                container.appendChild(badge);
            });
        }

        function updateTip() {
            const tip = cisoTips[Math.floor(Math.random() * cisoTips.length)];
            document.getElementById('cisoTip').textContent = tip;
        }

        // ==================== RENDERING ====================
        function drawGame() {
            const zone = zones[game.currentZone];

            // Clear and fill background
            ctx.fillStyle = zone.color;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw floor tiles
            ctx.fillStyle = '#ffffff08';
            for (let x = 0; x < MAP_WIDTH; x++) {
                for (let y = 0; y < MAP_HEIGHT; y++) {
                    if ((x + y) % 2 === 0) {
                        ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }
            }

            // Draw walls
            ctx.fillStyle = '#444';
            zone.walls.forEach(wall => {
                ctx.fillRect(wall.x * TILE_SIZE, wall.y * TILE_SIZE, TILE_SIZE, TILE_SIZE);

                // Wall top highlight
                ctx.fillStyle = '#555';
                ctx.fillRect(wall.x * TILE_SIZE, wall.y * TILE_SIZE, TILE_SIZE, 4);
                ctx.fillStyle = '#444';
            });

            // Draw exits (subtle glow)
            ctx.fillStyle = 'rgba(0, 255, 136, 0.2)';
            zone.exits.forEach(exit => {
                ctx.fillRect(exit.x * TILE_SIZE, exit.y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            });

            // Draw entities
            ctx.font = '24px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            game.entities.forEach(entity => {
                // Shadow
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.beginPath();
                ctx.ellipse(entity.x, entity.y + 12, 12, 6, 0, 0, Math.PI * 2);
                ctx.fill();

                // Sprite
                ctx.fillText(entity.sprite, entity.x, entity.y);

                // Enemy indicator
                if (entity.type === 'enemy') {
                    ctx.fillStyle = '#ff4444';
                    ctx.font = '10px Arial';
                    ctx.fillText('‚öîÔ∏è', entity.x, entity.y - 20);
                    ctx.font = '24px Arial';
                }
            });

            // Draw player
            ctx.fillStyle = 'rgba(233, 69, 96, 0.3)';
            ctx.beginPath();
            ctx.ellipse(game.player.x, game.player.y + 12, 14, 7, 0, 0, Math.PI * 2);
            ctx.fill();

            // Player sprite with bounce
            const bounce = Math.sin(Date.now() / 200) * 2;
            ctx.fillText('üé§', game.player.x, game.player.y + bounce);

            // Zone name
            ctx.fillStyle = '#ffffff44';
            ctx.font = '14px Courier New';
            ctx.textAlign = 'left';
            ctx.fillText(zone.name, 10, 25);
            ctx.font = '10px Courier New';
            ctx.fillText(zone.description, 10, 40);
        }

        // ==================== GAME LOOP ====================
        function gameLoop() {
            updatePlayer();
            drawGame();
            requestAnimationFrame(gameLoop);
        }

        // Initialize UI
        updateInventoryUI();
        updateQuestUI();
        updateCertificationsUI();
        updateTip();

        // Rotate tips
        setInterval(updateTip, 30000);

        // ==================== ZANY FEATURES ====================

        // D20 ROLL SYSTEM
        function rollD20() {
            return Math.floor(Math.random() * 20) + 1;
        }

        function showD20Roll(roll, isCrit, isFail) {
            const diceEl = document.createElement('div');
            diceEl.className = 'd20-roll';
            diceEl.textContent = `üé≤ ${roll}`;
            document.body.appendChild(diceEl);
            setTimeout(() => diceEl.remove(), 1000);

            if (isCrit) {
                const critEl = document.createElement('div');
                critEl.className = 'crit-text';
                critEl.textContent = '‚öîÔ∏è NATURAL 20! CRITICAL HIT! ‚öîÔ∏è';
                document.body.appendChild(critEl);
                setTimeout(() => critEl.remove(), 1500);
            } else if (isFail) {
                const failEl = document.createElement('div');
                failEl.className = 'crit-text';
                failEl.style.color = '#ff0000';
                failEl.textContent = 'üíÄ CRITICAL FAIL! üíÄ';
                document.body.appendChild(failEl);
                setTimeout(() => failEl.remove(), 1500);
            }
        }

        // KONAMI CODE DETECTION
        document.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();

            // Check Konami code
            if (key === KONAMI_CODE[game.konamiProgress]) {
                game.konamiProgress++;
                if (game.konamiProgress === KONAMI_CODE.length) {
                    activateCEOMode();
                    game.konamiProgress = 0;
                }
            } else {
                game.konamiProgress = 0;
            }

            // Secret command buffer
            if (!game.dialogActive && !game.karaokeActive && !game.meetingActive) {
                if (key.length === 1) {
                    game.secretBuffer += key;
                    if (game.secretBuffer.length > 20) {
                        game.secretBuffer = game.secretBuffer.slice(-20);
                    }
                    checkSecretCommands();
                } else if (key === 'backspace') {
                    game.secretBuffer = game.secretBuffer.slice(0, -1);
                } else if (key === 'enter') {
                    game.secretBuffer = '';
                }
            }

            // Q for duck consult
            if (key === 'q' && game.hasDuck && !game.dialogActive && !game.karaokeActive) {
                consultDuck();
            }
        });

        // CEO MODE
        function activateCEOMode() {
            game.ceoMode = true;
            document.getElementById('gameCanvas').classList.add('ceo-mode');
            document.querySelector('.stats-panel').classList.add('ceo-mode');

            showCEOPopup("üéâ CEO MODE ACTIVATED! üéâ");

            // Start random CEO interruptions
            setInterval(() => {
                if (game.ceoMode && !game.dialogActive && !game.karaokeActive && Math.random() < 0.3) {
                    const msg = CEO_INTERRUPTIONS[Math.floor(Math.random() * CEO_INTERRUPTIONS.length)];
                    showCEOPopup(msg);
                }
            }, 15000);

            game.player.charisma = 99;
            updateStatsUI();
        }

        function showCEOPopup(message) {
            const popup = document.createElement('div');
            popup.className = 'ceo-popup';
            popup.textContent = message;
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 2000);
        }

        // SECRET COMMANDS
        function checkSecretCommands() {
            for (const [cmd, response] of Object.entries(SECRET_COMMANDS)) {
                if (game.secretBuffer.includes(cmd)) {
                    showSecretToast(response);
                    game.secretBuffer = '';

                    // Special effects for some commands
                    if (cmd === 'coffee') {
                        addCaffeine(10);
                    } else if (cmd === 'password') {
                        game.player.hp -= 10;
                        updateStatsUI();
                    }
                    break;
                }
            }
        }

        function showSecretToast(message) {
            const toast = document.createElement('div');
            toast.className = 'secret-toast';
            toast.innerHTML = `<pre>$ ${game.secretBuffer}_</pre><p>${message}</p>`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // RUBBER DUCK SYSTEM
        function consultDuck() {
            if (!game.hasDuck) return;

            game.duckConsults++;
            const wisdom = DUCK_WISDOM[Math.floor(Math.random() * DUCK_WISDOM.length)];

            // Duck gets more sarcastic with more consults
            let message = wisdom;
            if (game.duckConsults > 10) {
                message = "*sigh* " + wisdom + " (You've asked me " + game.duckConsults + " times now...)";
            } else if (game.duckConsults > 5) {
                message = wisdom + " (Consult #" + game.duckConsults + ")";
            }

            const speech = document.getElementById('duckSpeech');
            speech.textContent = message;
            speech.style.display = 'block';

            // Duck animation
            const duck = document.getElementById('rubberDuck');
            duck.style.transform = 'scale(1.3) rotate(10deg)';
            setTimeout(() => duck.style.transform = '', 200);

            setTimeout(() => speech.style.display = 'none', 4000);
        }

        function acquireDuck() {
            game.hasDuck = true;
            document.getElementById('rubberDuck').style.display = 'block';
        }

        // COFFEE/CAFFEINE SYSTEM
        function addCaffeine(amount) {
            game.caffeine = Math.min(100, game.caffeine + amount);
            document.getElementById('coffeeCounter').style.display = 'block';
            document.getElementById('caffeineLevel').textContent = game.caffeine;

            if (game.caffeine >= 80) {
                document.body.classList.add('caffeine-shake');
                game.player.speed = 6;
            } else if (game.caffeine >= 50) {
                game.player.speed = 5;
            }

            if (game.caffeine >= 100) {
                showSecretToast("‚òïüí• CAFFEINE OVERDOSE! You need PTO to recover!");
                game.player.hp -= 20;
                game.caffeine = 50;
                updateStatsUI();
            }
        }

        // Caffeine decay
        setInterval(() => {
            if (game.caffeine > 0) {
                game.caffeine = Math.max(0, game.caffeine - 1);
                document.getElementById('caffeineLevel').textContent = game.caffeine;
                if (game.caffeine < 50) {
                    game.player.speed = 4;
                    document.body.classList.remove('caffeine-shake');
                }
                if (game.caffeine === 0) {
                    document.getElementById('coffeeCounter').style.display = 'none';
                }
            }
        }, 2000);

        // MEETING SURVIVAL MINIGAME
        function triggerRandomMeeting() {
            if (Math.random() < 0.1 && !game.dialogActive && !game.karaokeActive && !game.meetingActive) {
                startMeeting();
            }
        }

        function startMeeting() {
            game.meetingActive = true;
            game.sleepiness = 0;
            document.getElementById('meetingOverlay').style.display = 'flex';
            document.getElementById('sleepyFill').style.width = '0%';
            document.getElementById('meetingClicker').textContent = 'üòê';

            // Sleepiness increases
            game.meetingInterval = setInterval(() => {
                game.sleepiness += 5;
                document.getElementById('sleepyFill').style.width = game.sleepiness + '%';
                document.getElementById('meetingBuzz').textContent =
                    MEETING_BUZZWORDS[Math.floor(Math.random() * MEETING_BUZZWORDS.length)];

                // Update face
                if (game.sleepiness > 80) {
                    document.getElementById('meetingClicker').textContent = 'üò¥';
                } else if (game.sleepiness > 50) {
                    document.getElementById('meetingClicker').textContent = 'üò™';
                } else if (game.sleepiness > 30) {
                    document.getElementById('meetingClicker').textContent = 'üòë';
                }

                if (game.sleepiness >= 100) {
                    endMeeting(false);
                }
            }, 500);

            // Meeting ends after time
            setTimeout(() => {
                if (game.meetingActive) endMeeting(true);
            }, 15000);
        }

        function clickToStayAwake() {
            game.sleepiness = Math.max(0, game.sleepiness - 15);
            document.getElementById('sleepyFill').style.width = game.sleepiness + '%';
            document.getElementById('meetingClicker').textContent = 'üòÉ';
            setTimeout(() => {
                if (game.sleepiness > 50) {
                    document.getElementById('meetingClicker').textContent = 'üò™';
                } else {
                    document.getElementById('meetingClicker').textContent = 'üòê';
                }
            }, 200);
        }

        function endMeeting(survived) {
            clearInterval(game.meetingInterval);
            game.meetingActive = false;
            document.getElementById('meetingOverlay').style.display = 'none';

            if (survived) {
                addXp(20);
                showSecretToast("‚úÖ You survived the meeting! +20 XP");
            } else {
                game.player.hp -= 15;
                updateStatsUI();
                showSecretToast("üí§ You fell asleep! -15 HP. Let's take this offline...");
            }
        }

        // Random meeting trigger
        setInterval(triggerRandomMeeting, 60000);

        // ENHANCED KARAOKE WITH D20 CRITS
        const originalHandleKaraokeInput = handleKaraokeInput;
        handleKaraokeInput = function(key) {
            const keyMap = {j: 0, k: 1, l: 2, m: 3};
            const lane = keyMap[key];

            if (lane === undefined) return;

            // Visual feedback
            const keyPrompt = document.getElementById('key' + key.toUpperCase());
            keyPrompt.classList.add('active');
            setTimeout(() => keyPrompt.classList.remove('active'), 100);

            // Check for hit
            const hitZone = {min: 60, max: 90};
            let hit = false;

            for (const note of karaokeState.notes) {
                const pos = parseInt(note.style.top);
                const noteLane = parseInt(note.dataset.lane);

                if (noteLane === lane && pos >= hitZone.min && pos <= hitZone.max) {
                    // D20 ROLL FOR DAMAGE!
                    const roll = rollD20();
                    const isCrit = roll === 20;
                    const isFail = roll === 1;

                    showD20Roll(roll, isCrit, isFail);

                    hit = true;
                    karaokeState.combo++;

                    let damage = 5 + karaokeState.combo;
                    let score = 10 * (1 + Math.floor(karaokeState.combo / 5));

                    if (isCrit) {
                        damage *= 3;
                        score *= 2;
                        karaokeState.combo += 2;
                    } else if (isFail) {
                        damage = 1;
                        score = 1;
                        showSecretToast("üíÄ CRIT FAIL: You accidentally CC'd all-staff!");
                    }

                    karaokeState.score += score;
                    karaokeState.enemyHp -= damage;

                    note.style.background = isCrit ? '#ffd700' : '#ff4444';
                    clearInterval(note.dataset.interval);
                    setTimeout(() => note.remove(), 100);

                    karaokeState.notes = karaokeState.notes.filter(n => n !== note);

                    document.getElementById('karaokeScore').textContent = karaokeState.score;
                    document.getElementById('karaokeCombo').textContent = karaokeState.combo;
                    document.getElementById('enemyHp').textContent = Math.max(0, karaokeState.enemyHp);

                    karaokeState.lyricIndex = (karaokeState.lyricIndex + 1) % karaokeState.enemy.lyrics.length;
                    document.getElementById('lyricsDisplay').textContent =
                        securityLyrics[Math.floor(Math.random() * securityLyrics.length)];

                    break;
                }
            }

            if (!hit) {
                karaokeState.combo = 0;
                document.getElementById('karaokeCombo').textContent = '0';
            }

            if (karaokeState.enemyHp <= 0) {
                endKaraokeBattle(true);
            } else if (karaokeState.notes.length === 0 && karaokeState.enemyHp > 0) {
                setTimeout(spawnKaraokeNotes, 500);
            }
        };

        // ENHANCED DIALOG TO HANDLE DUCK ACQUISITION
        const originalEndDialog = endDialog;
        endDialog = function() {
            const npc = game.currentNpc;

            // Check if NPC gives duck
            if (npc && npc.givesDuck && !game.hasDuck) {
                acquireDuck();
            }

            document.getElementById('dialogBox').style.display = 'none';
            game.dialogActive = false;

            if (npc.questId) {
                const quest = game.player.quests.find(q => q.id === npc.questId);
                if (quest && !quest.completed) {
                    quest.completed = true;
                    addXp(25);
                    updateQuestUI();
                }
            }

            if (npc.givesItem && !npc.collected) {
                addItem(npc.givesItem);
                npc.collected = true;
                const idx = game.entities.findIndex(e => e === npc);
                if (idx > -1) game.entities.splice(idx, 1);
                const zoneNpc = zones[game.currentZone].npcs.find(n => n.name === npc.name);
                if (zoneNpc) zoneNpc.collected = true;
            }

            if (npc.checkWin) {
                checkWinCondition();
            }

            game.currentNpc = null;
        };

        // ADD COFFEE PICKUPS TO ZONES
        function spawnCoffee() {
            if (Math.random() < 0.05) {
                game.entities.push({
                    x: Math.random() * 500 + 70,
                    y: Math.random() * 350 + 70,
                    sprite: '‚òï',
                    name: 'Coffee',
                    type: 'coffee'
                });
            }
        }

        // OVERRIDE checkInteraction to handle coffee
        const originalCheckInteraction = checkInteraction;
        checkInteraction = function() {
            const interactionRange = 50;

            for (let i = game.entities.length - 1; i >= 0; i--) {
                const entity = game.entities[i];
                const dx = entity.x - game.player.x;
                const dy = entity.y - game.player.y;
                const dist = Math.sqrt(dx * dx + dy * dy);

                if (dist < interactionRange) {
                    if (entity.type === 'coffee') {
                        addCaffeine(15);
                        game.entities.splice(i, 1);
                        showSecretToast("‚òï Caffeine boost! +15%");
                        return;
                    } else if (entity.type === 'npc') {
                        startDialog(entity);
                        return;
                    } else if (entity.type === 'enemy') {
                        startKaraokeBattle(entity);
                        return;
                    }
                }
            }
        };

        // Spawn coffee occasionally
        setInterval(spawnCoffee, 30000);

        // DRAW SECRET EXITS DIFFERENTLY
        const originalDrawGame = drawGame;
        drawGame = function() {
            const zone = zones[game.currentZone];

            ctx.fillStyle = zone.color;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Shadow IT has special starfield background
            if (game.currentZone === 'shadow_it') {
                for (let i = 0; i < 50; i++) {
                    ctx.fillStyle = `rgba(255,255,255,${Math.random() * 0.5})`;
                    ctx.fillRect(
                        (Math.sin(Date.now()/1000 + i) + 1) * 320,
                        (Math.cos(Date.now()/1500 + i*2) + 1) * 240,
                        2, 2
                    );
                }
            }

            ctx.fillStyle = '#ffffff08';
            for (let x = 0; x < MAP_WIDTH; x++) {
                for (let y = 0; y < MAP_HEIGHT; y++) {
                    if ((x + y) % 2 === 0) {
                        ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }
            }

            ctx.fillStyle = '#444';
            zone.walls.forEach(wall => {
                ctx.fillRect(wall.x * TILE_SIZE, wall.y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                ctx.fillStyle = '#555';
                ctx.fillRect(wall.x * TILE_SIZE, wall.y * TILE_SIZE, TILE_SIZE, 4);
                ctx.fillStyle = '#444';
            });

            // Draw exits - secret ones pulse
            zone.exits.forEach(exit => {
                if (exit.secret) {
                    const pulse = Math.sin(Date.now() / 300) * 0.3 + 0.3;
                    ctx.fillStyle = `rgba(128, 0, 255, ${pulse})`;
                } else {
                    ctx.fillStyle = 'rgba(0, 255, 136, 0.2)';
                }
                ctx.fillRect(exit.x * TILE_SIZE, exit.y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            });

            ctx.font = '24px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            game.entities.forEach(entity => {
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.beginPath();
                ctx.ellipse(entity.x, entity.y + 12, 12, 6, 0, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillText(entity.sprite, entity.x, entity.y);

                if (entity.type === 'enemy') {
                    ctx.fillStyle = '#ff4444';
                    ctx.font = '10px Arial';
                    ctx.fillText('‚öîÔ∏è', entity.x, entity.y - 20);
                    ctx.font = '24px Arial';
                }
            });

            // Draw player with caffeine shake effect
            let playerX = game.player.x;
            let playerY = game.player.y;
            if (game.caffeine >= 80) {
                playerX += (Math.random() - 0.5) * 4;
                playerY += (Math.random() - 0.5) * 4;
            }

            ctx.fillStyle = game.ceoMode ? 'rgba(255, 215, 0, 0.4)' : 'rgba(233, 69, 96, 0.3)';
            ctx.beginPath();
            ctx.ellipse(playerX, playerY + 12, 14, 7, 0, 0, Math.PI * 2);
            ctx.fill();

            const bounce = Math.sin(Date.now() / 200) * 2;
            ctx.fillText('üé§', playerX, playerY + bounce);

            // CEO mode crown
            if (game.ceoMode) {
                ctx.fillText('üëë', playerX, playerY - 20 + bounce);
            }

            ctx.fillStyle = '#ffffff44';
            ctx.font = '14px Courier New';
            ctx.textAlign = 'left';
            ctx.fillText(zone.name, 10, 25);
            ctx.font = '10px Courier New';
            ctx.fillText(zone.description, 10, 40);

            // Easter egg posters
            if (game.currentZone === 'it_dungeon') {
                ctx.fillStyle = '#ffffff22';
                ctx.font = '8px Courier New';
                ctx.fillText('üìã Days Since Last Phishing Click: 0', 400, 460);
            }
            if (game.currentZone === 'audit_arena') {
                ctx.fillStyle = '#ffffff22';
                ctx.font = '8px Courier New';
                ctx.fillText('üèÜ Fastest IR: 47 days', 450, 460);
            }
            if (game.currentZone === 'lobby') {
                ctx.fillStyle = '#ffffff22';
                ctx.font = '8px Courier New';
                ctx.fillText('üéñÔ∏è "I survived SolarWinds \'20"', 10, 460);
            }
        };

        console.log('%cüé§ The Ballad of the CISO üé∏', 'font-size: 20px; color: #e94560;');
        console.log('%cSecret: Try typing "sudo" or "coffee"... or find the Konami Code!', 'color: #00ff88;');
        console.log('%c‚Üë‚Üë‚Üì‚Üì‚Üê‚Üí‚Üê‚ÜíBA', 'color: #888;');
    </script>
</body>
</html>
